groups:
  - name: cas-system-alerts
    rules:
      # Service Health Alerts
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} has been down for more than 1 minute"

      - alert: ServiceHighErrorRate
        expr: rate(processing_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate in {{ $labels.job }}"
          description: "Error rate is {{ $value }} errors per second"

      # Processing Alerts
      - alert: ProcessingQueueBacklog
        expr: processing_queue_size > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Processing queue backlog detected"
          description: "Queue size is {{ $value }} jobs"

      - alert: ProcessingQueueFull
        expr: processing_queue_size > 500
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Processing queue is full"
          description: "Queue size is {{ $value }} jobs"

      - alert: ProcessingStuck
        expr: rate(documents_processed_total[10m]) == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Document processing appears to be stuck"
          description: "No documents processed in the last 10 minutes"

      # LLM Alerts
      - alert: LLMServiceDown
        expr: up{job="llm-manager"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "LLM Manager service is down"
          description: "LLM classification will fall back to rule-based classification"

      - alert: LLMHighLatency
        expr: rate(llm_classification_duration_seconds_sum[5m]) / rate(llm_classification_duration_seconds_count[5m]) > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "LLM classification is slow"
          description: "Average response time is {{ $value }} seconds"

      - alert: LLMHighErrorRate
        expr: rate(llm_classification_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High LLM classification error rate"
          description: "Error rate is {{ $value }} errors per second"

      # Email Processing Alerts
      - alert: EmailProcessingDown
        expr: up{job="email-processor"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Email processor service is down"
          description: "Email processing is not available"

      - alert: EmailProcessingErrors
        expr: rate(email_processing_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Email processing errors detected"
          description: "Error rate is {{ $value }} errors per second"

      # OTRS Integration Alerts
      - alert: OTRSIntegrationDown
        expr: up{job="otrs-integration"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "OTRS integration service is down"
          description: "OTRS ticket processing is not available"

      - alert: OTRSAPIErrors
        expr: rate(otrs_api_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "OTRS API errors detected"
          description: "Error rate is {{ $value }} errors per second"

      # Backup Alerts
      - alert: BackupServiceDown
        expr: up{job="backup-service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Backup service is down"
          description: "Automatic backups are not running"

      - alert: BackupFailed
        expr: backup_last_success_timestamp < (time() - 86400)
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "Backup has not completed successfully in 24 hours"
          description: "Last successful backup was more than 24 hours ago"

      - alert: BackupTooLarge
        expr: backup_size_bytes > 10737418240  # 10GB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Backup size is very large"
          description: "Backup size is {{ $value }} bytes"

      # Storage Alerts
      - alert: StorageSpaceLow
        expr: minio_bucket_size_bytes / minio_bucket_capacity_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Storage space is running low"
          description: "Storage usage is {{ $value | humanizePercentage }}"

      - alert: StorageSpaceCritical
        expr: minio_bucket_size_bytes / minio_bucket_capacity_bytes > 0.95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Storage space is critically low"
          description: "Storage usage is {{ $value | humanizePercentage }}"

      # Database Alerts
      - alert: DatabaseSizeLarge
        expr: postgres_database_size_bytes > 5368709120  # 5GB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database size is very large"
          description: "Database size is {{ $value }} bytes"

      - alert: DatabaseConnectionsHigh
        expr: postgres_connections_active / postgres_connections_max > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database connection usage"
          description: "Connection usage is {{ $value | humanizePercentage }}"

      # System Resource Alerts
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value }}%"

      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1073741824 > 2  # 2GB
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value }} GB"

      # Duplicate Detection Alerts
      - alert: HighDuplicateRate
        expr: rate(duplicates_detected_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High duplicate detection rate"
          description: "Duplicate rate is {{ $value }} duplicates per minute"

      # Classification Accuracy Alerts
      - alert: LowClassificationAccuracy
        expr: rate(classification_correct_total[5m]) / (rate(classification_correct_total[5m]) + rate(classification_incorrect_total[5m])) < 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low classification accuracy"
          description: "Classification accuracy is {{ $value | humanizePercentage }}"

      # Rollback Alerts
      - alert: FrequentRollbacks
        expr: rate(rollback_operations_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Frequent rollback operations"
          description: "Rollback rate is {{ $value }} rollbacks per minute"

      # Network Alerts
      - alert: NetworkLatencyHigh
        expr: rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High network latency detected"
          description: "Average request duration is {{ $value }} seconds"

      # Security Alerts
      - alert: UnauthorizedAccess
        expr: rate(http_requests_total{status=~"4.."}[5m]) > 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High rate of unauthorized access attempts"
          description: "Unauthorized access rate is {{ $value }} requests per minute"

      # Integration Alerts
      - alert: IntegrationFailure
        expr: rate(integration_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Integration failures detected"
          description: "Integration failure rate is {{ $value }} failures per minute"

      # Performance Alerts
      - alert: SlowProcessing
        expr: rate(processing_duration_seconds_sum[5m]) / rate(processing_duration_seconds_count[5m]) > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow document processing detected"
          description: "Average processing time is {{ $value }} seconds"

      # Availability Alerts
      - alert: ServiceUnavailable
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Service unavailable errors detected"
          description: "5xx error rate is {{ $value }} errors per minute" 